<div class="section-container subsection-grid-container">
  <nz-card class="section-title">
    <h2 class="page-title">Workflows</h2>
    <nz-button-group
      class="utility-button-group"
      ngbDropdown>
      <a
        [nzDropdownMenu]="sortOptions"
        nz-dropdown>
        <button
          title="Sort"
          id="sortDropdown"
          ngbDropdownToggle
          nz-button>
          <i
            nz-icon
            nzTheme="outline"
            nzType="sort-ascending"></i>
        </button>
      </a>
      <nz-dropdown-menu #sortOptions="nzDropdownMenu">
        <ul nz-menu>
          <li nz-menu-item>
            <button
              (click)="lastSort()"
              class="sorting_func"
              nz-button>
              By Edit Time
            </button>
          </li>
          <li nz-menu-item>
            <button
              (click)="dateSort()"
              class="sorting_func"
              nz-button>
              By Create Time
            </button>
          </li>
          <li nz-menu-item>
            <button
              (click)="ascSort()"
              class="sorting_func"
              nz-button>
              A -> Z
            </button>
          </li>
          <li nz-menu-item>
            <button
              (click)="dscSort()"
              class="sorting_func"
              nz-button>
              Z -> A
            </button>
          </li>
        </ul>
      </nz-dropdown-menu>
      <button
        (click)="onClickCreateNewWorkflowFromDashboard()"
        nz-button
        title="Create a new workflow"
        nz-tooltip="Create a new workflow"
        nzTooltipPlacement="bottom"
        type="button">
        <i
          nz-icon
          nzTheme="outline"
          nzType="file-add"></i>
      </button>
      <button
        [disabled]="!zipDownloadButtonEnabled"
        (click)="onClickOpenDownloadZip()"
        nz-button
        title="Download added workflow as a ZIP file"
        nz-tooltip="Download added workflow as a ZIP file"
        nzTooltipPlacement="bottom"
        type="button">
        <i
          nz-icon
          nzType="cloud-download"
          nzTheme="outline"></i>
      </button>
      <nz-upload [nzBeforeUpload]="onClickUploadExistingWorkflowFromLocal">
        <button
          nz-button
          title="Upload ZIP/JSON file as workflow"
          nz-tooltip="Upload ZIP/JSON file as workflow"
          nzTooltipPlacement="bottom"
          type="button">
          <i
            nz-icon
            nzType="cloud-upload"
            nzTheme="outline"></i>
        </button>
      </nz-upload>

      <button
        *ngIf="pid !== 0"
        (click)="onClickOpenAddWorkflow()"
        nz-button
        title="Add workflow(s) to project"
        nz-tooltip="Add workflow(s) to project"
        nzTooltipPlacement="bottom"
        type="button">
        <i
          nz-icon
          nzTheme="outline"
          nzType="plus-square"></i>
      </button>
      <button
        *ngIf="pid !== 0"
        (click)="onClickOpenRemoveWorkflow()"
        nz-button
        title="Remove workflow(s) from project"
        nz-tooltip="Remove workflow(s) from project"
        nzTooltipPlacement="bottom"
        type="button">
        <i
          nz-icon
          nzTheme="outline"
          nzType="minus-square"></i>
      </button>
    </nz-button-group>

    <nz-button-group
      class="filter-button-group"
      ngbDropdown>
      <a
        [nzDropdownMenu]="mtimeSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'border-style': 'double'}"
        class="modification-time-button">
        <button
          id="mtimeSort"
          ngbDropdownToggle
          nz-button
          title="Modification Time">
          <i
            nz-icon
            nzType="form"
            nzTheme="outline"
            nz-tooltip="Modification Time"></i>
        </button>
      </a>

      <nz-dropdown-menu #mtimeSearchOptions="nzDropdownMenu">
        <nz-range-picker
          nzInline
          [(ngModel)]="selectedMtime"
          (ngModelChange)="searchWorkflow()"
          ngDefaultControl></nz-range-picker>
      </nz-dropdown-menu>

      <a
        [nzDropdownMenu]="ctimeSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'border-style': 'double'}"
        class="search-creation-time-button">
        <button
          id="ctimeSort"
          ngbDropdownToggle
          nz-button
          title="Creation Time">
          <i
            nz-icon
            nzType="calendar"
            nzTheme="outline"
            nz-tooltip="Creation Time"></i>
        </button>
      </a>
      <nz-dropdown-menu #ctimeSearchOptions="nzDropdownMenu">
        <nz-range-picker
          nzInline
          [(ngModel)]="selectedCtime"
          (ngModelChange)="searchWorkflow()"
          ngDefaultControl></nz-range-picker>
      </nz-dropdown-menu>

      <a
        [nzDropdownMenu]="ownerSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'overflow-y': 'scroll', 'max-height': '250px', 'border-style': 'double'}"
        class="search-owners-button">
        <button
          id="sortOwner"
          ngbDropdownToggle
          nz-button
          title="Owner">
          <i
            nz-icon
            nzTheme="outline"
            nzType="user"
            nz-tooltip="Owner"></i>
        </button>
      </a>
      <nz-dropdown-menu #ownerSearchOptions="nzDropdownMenu">
        <ul
          nz-menu
          *ngFor="let owner of owners">
          <li nz-menu-item>
            <label
              nz-checkbox
              ngDefaultControl
              [(ngModel)]="owner.checked"
              (ngModelChange)="updateSelectedOwners()"
              >{{owner.userName}}</label
            >
          </li>
        </ul>
      </nz-dropdown-menu>

      <a
        [nzDropdownMenu]="IDSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'overflow-y': 'scroll', 'max-height': '250px', 'border-style': 'double'}"
        class="search-wids-button">
        <button
          id="sortID"
          ngbDropdownToggle
          nz-button
          title="Workflow ID">
          <i
            nz-icon
            nzTheme="outline"
            nzType="ordered-list"
            nz-tooltip="Workflow ID"></i>
        </button>
      </a>
      <nz-dropdown-menu #IDSearchOptions="nzDropdownMenu">
        <ul
          nz-menu
          *ngFor="let wid of wids">
          <li nz-menu-item>
            <label
              nz-checkbox
              ngDefaultControl
              [(ngModel)]="wid.checked"
              (ngModelChange)="updateSelectedIDs()"
              >{{wid.id}}</label
            >
          </li>
        </ul>
      </nz-dropdown-menu>

      <a
        [nzDropdownMenu]="operatorSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'border-style': 'double'}"
        class="search-operators-button">
        <button
          id="sortOperator"
          ngbDropdownToggle
          nz-button
          title="Operators">
          <i
            nz-icon
            nzType="appstore"
            nzTheme="outline"
            nz-tooltip="Operators"></i>
        </button>
      </a>
      <nz-dropdown-menu #operatorSearchOptions="nzDropdownMenu">
        <ul
          nz-menu
          *ngFor="let group of operatorGroups">
          <li
            nz-submenu
            nzTitle="{{group}}">
            <ul *ngFor="let operator of operators.get(group)">
              <li nz-menu-item>
                <label
                  nz-checkbox
                  ngDefaultControl
                  [(ngModel)]="operator.checked"
                  (ngModelChange)="updateSelectedOperators()"
                  >{{operator.userFriendlyName}}</label
                >
              </li>
            </ul>
          </li>
        </ul>
      </nz-dropdown-menu>

      <a
        [nzDropdownMenu]="projectSearchOptions"
        nz-dropdown
        nzTrigger="click"
        [nzOverlayStyle]="{'overflow-y': 'scroll', 'max-height': '250px', 'border-style': 'double'}"
        class="search-projects-button">
        <button
          id="sortProject"
          ngbDropdownToggle
          nz-button
          title="Projects">
          <i
            nz-icon
            nzType="file"
            nzTheme="outline"
            nz-tooltip="Projects"></i>
        </button>
      </a>
      <nz-dropdown-menu #projectSearchOptions="nzDropdownMenu">
        <ul
          nz-menu
          *ngFor="let project of userProjectsDropdown">
          <li nz-menu-item>
            <label
              nz-checkbox
              ngDefaultControl
              [(ngModel)]="project.checked"
              (ngModelChange)="updateSelectedProjects()"
              >{{project.name}}</label
            >
          </li>
        </ul>
      </nz-dropdown-menu>
    </nz-button-group>
  </nz-card>

  <div class="section-search-bar workflow-search-bar">
    <i
      class="search-info-box"
      nz-icon
      nz-popover
      nzPopoverTitle="Filter Instructions"
      nzType="question-circle"
      nzTheme="outline"
      [nzPopoverContent]="filterPopContent"></i>
    <nz-select
      class="search-input-box"
      nzMode="tags"
      nzPlaceHolder="Search all workflows"
      [nzBorderless]="true"
      [nzOpen]="false"
      ngDefaultControl
      [(ngModel)]="masterFilterList"
      [nzAllowClear]="true"
      (ngModelChange)="updateDropdownMenus($event)">
    </nz-select>
    <ng-template #filterPopContent>
      We support the following search criteria:
      <ul>
        <li>Search by Workflow Name: <strong>workflowName</strong></li>
        <li>Search by Workflow Creation Time: <strong>ctime: yyyy-MM-dd</strong></li>
        <li>Search by Workflow Modification Time: <strong>mtime: yyyy-MM-dd</strong></li>
        <li>Search by Workflow Owner: <strong>owner: John</strong></li>
        <li>Search by Workflow Id: <strong>id: workflowId</strong></li>
        <li>Search by Workflows' Operators: <strong>operator: operatorName</strong></li>
        <li>Search by User Projects: <strong>project: projectName</strong></li>
      </ul>
      You can change search parameters by:
      <ul>
        <li>selecting/unselecting dropdown menu options</li>
        <li>manually typing parameters into search bar</li>
        <li>clicking the <strong>X</strong> on a tag or the search bar, to clear one or all tags</li>
      </ul>
      <br />
      Example: "Untitled Workflow" id:1 owner:John<br />
      Meaning: Search for the workflow with name Untitled Workflow, id 1, and the owner called John.
    </ng-template>
  </div>

  <nz-card class="section-list-container">
    <!-- itemSize: the height (px) of each list item,
      this MUST be approximately the same as list item size set in CSS,
      .workflow-list-item sets the item size to be 70px, with additional paddings/margins it's approximately 80px
    -->
    <cdk-virtual-scroll-viewport
      itemSize="80"
      class="virtual-scroll-container">
      <nz-list>
        <texera-user-workflow-list-item
          [entry]="dashboardWorkflowEntry"
          [owners]="owners"
          (deleted)="deleteWorkflow(dashboardWorkflowEntry)"
          (duplicated)="onClickDuplicateWorkflow(dashboardWorkflowEntry)"
          [pid]="pid"
          [userProjectsLoaded]="userProjectsLoaded"
          [userProjectsMap]="userProjectsMap"
          *cdkVirtualFor="let dashboardWorkflowEntry of dashboardWorkflowEntries;let indexOfElement=index">
        </texera-user-workflow-list-item>
      </nz-list>
    </cdk-virtual-scroll-viewport>
  </nz-card>
</div>
