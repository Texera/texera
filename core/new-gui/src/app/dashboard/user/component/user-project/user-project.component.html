<div>
  <nz-card>
    <h2>Projects</h2>
    <a
      [nzDropdownMenu]="menu"
      nz-dropdown>
      <button nz-button>
        <i
          nz-icon
          nzTheme="outline"
          nzType="sort-ascending"></i>
      </button>
    </a>
    <nz-dropdown-menu #menu="nzDropdownMenu">
      <ul
        nz-menu
        nzSelectable>
        <li
          (click)="sortByCreationTime()"
          nz-menu-item>
          By Time Created
        </li>
        <li
          (click)="sortByNameAsc()"
          nz-menu-item>
          A -> Z
        </li>
        <li
          (click)="sortByNameDesc()"
          nz-menu-item>
          Z -> A
        </li>
      </ul>
    </nz-dropdown-menu>
    <button
      (click)="clickCreateButton()"
      nz-button
      nz-tooltip="Create a new project"
      nzTooltipPlacement="bottom"
      type="button">
      <i
        nz-icon
        nzTheme="outline"
        nzType="file-add"></i>
    </button>
    <input
      (focusout)="unclickCreateButton()"
      (keyup.enter)="createNewProject()"
      *ngIf="createButtonIsClicked"
      [(ngModel)]="createProjectName"
      nz-input
      placeholder="Enter project name" />
  </nz-card>

  <nz-card>
    <nz-list>
      <nz-list-item *ngFor="let dashboardUserProjectEntry of userProjectEntries; let i = index">
        <nz-list-item-meta>
          <nz-list-item-meta-avatar>
            <div class="project-avatar-container">
              <nz-avatar
                (colorPickerSelect)="updateProjectColor(dashboardUserProjectEntry, i)"
                [(colorPicker)]="userProjectInputColors[userProjectToColorInputIndexMap.get(dashboardUserProjectEntry.pid)!]"
                [(cpToggle)]="colorInputToggleArray[i]"
                [cpExtraTemplate]="colorMenuTemplate"
                [cpPresetColors]="['#ff85c0', '#ff8c50', '#bae637', '#36cfc9', '#9254de', '#808080']"
                [cpSaveClickOutside]="false"
                [ngStyle]="{ 'background-color': dashboardUserProjectEntry.color === null ? 'grey' : '#' + dashboardUserProjectEntry.color, 'color' : colorBrightnessMap.get(dashboardUserProjectEntry.pid) ? 'black' : 'white'}"
                [nzGap]="4"
                [nzText]="'' + dashboardUserProjectEntry.pid"
                nzSize="default"></nz-avatar>
              <ng-template #colorMenuTemplate>
                <div style="display: flex; padding: 0 16px 16px; justify-content: space-between">
                  <button
                    (click)="removeProjectColor(dashboardUserProjectEntry, i)"
                    [disabled]="dashboardUserProjectEntry.color === null"
                    class="btn btn-outline-danger btn-xs">
                    Delete
                  </button>
                  <button
                    (click)="updateProjectColor(dashboardUserProjectEntry, i)"
                    class="btn btn-primary btn-xs">
                    Save
                  </button>
                </div>
              </ng-template>
            </div>
          </nz-list-item-meta-avatar>

          <!-- editable name of saved workflow -->
          <nz-list-item-meta-title>
            <ng-container
              *ngIf="userProjectEntriesIsEditingName.indexOf(dashboardUserProjectEntry.pid) === -1;else editingProject">
              <a
                [routerLink]="ROUTER_USER_PROJECT_BASE_URL + '/' + dashboardUserProjectEntry.pid"
                class="project-name">
                {{dashboardUserProjectEntry.name}}</a
              >
              <button
                (click)="userProjectEntriesIsEditingName.push(dashboardUserProjectEntry.pid)"
                nz-button
                nz-tooltip="Edit Project Name"
                nzSize="small"
                nzTooltipPlacement="top"
                nzType="text">
                <i
                  class="edit-name-icon"
                  nz-icon
                  nzTheme="outline"
                  nzType="edit"></i>
              </button>
              <button
                (click)="userProjectEntriesIsEditingDescription.push(dashboardUserProjectEntry.pid)"
                nz-button
                nz-tooltip="Add / Edit Description"
                nzSize="small"
                nzTooltipPlacement="top"
                nzType="text">
                <i
                  class="edit-description-icon"
                  nz-icon
                  nzTheme="outline"
                  nzType="plus-square"></i>
              </button>
              <button
                (click)="collapsedProjectDescriptions.push(dashboardUserProjectEntry.pid)"
                *ngIf="dashboardUserProjectEntry.description && dashboardUserProjectEntry.description.trim() && collapsedProjectDescriptions.indexOf(dashboardUserProjectEntry.pid) === -1"
                nz-button
                nz-tooltip="Collapse Description"
                nzSize="small"
                nzTooltipPlacement="top"
                nzType="text">
                <i
                  nz-icon
                  nzTheme="outline"
                  nzType="up-square"></i>
              </button>
              <button
                (click)="removeCollapsedProjectDescriptionStatus(dashboardUserProjectEntry.pid)"
                *ngIf="dashboardUserProjectEntry.description && dashboardUserProjectEntry.description.trim() && collapsedProjectDescriptions.indexOf(dashboardUserProjectEntry.pid) !== -1"
                nz-button
                nz-tooltip="Expand Description"
                nzSize="small"
                nzTooltipPlacement="top"
                nzType="text">
                <i
                  nz-icon
                  nzTheme="outline"
                  nzType="down-square"></i>
              </button>
            </ng-container>

            <ng-template #editingProject>
              <input
                #editedName
                (focusout)="removeEditNameStatus(dashboardUserProjectEntry.pid)"
                (keyup.enter)="saveProjectName(dashboardUserProjectEntry, editedName.value)"
                placeholder="{{ dashboardUserProjectEntry.name }}"
                value="{{ dashboardUserProjectEntry.name }}" />
            </ng-template>
          </nz-list-item-meta-title>

          <!-- editable project description -->
          <nz-list-item-meta-description>
            <ng-container
              *ngIf="userProjectEntriesIsEditingDescription.indexOf(dashboardUserProjectEntry.pid) === -1;else editingDescription">
              <div
                *ngIf="dashboardUserProjectEntry.description && dashboardUserProjectEntry.description.trim() && collapsedProjectDescriptions.indexOf(dashboardUserProjectEntry.pid) === -1"
                class="description-container">
                <markdown [data]="dashboardUserProjectEntry.description"></markdown>
              </div>
            </ng-container>

            <ng-template #editingDescription>
              <nz-input-group
                [nzSuffix]="saveDescriptionIcon"
                class="ant-input-affix-wrapper-textarea-with-clear-btn">
                <textarea
                  #descriptionBox
                  (focusout)="saveProjectDescription(dashboardUserProjectEntry, descriptionBox.value, i)"
                  [attr.maxlength]="MAX_PROJECT_DESCRIPTION_CHAR_COUNT"
                  nz-input
                  nzAutosize
                  placeholder="Enter project description">
{{dashboardUserProjectEntry.description}}</textarea
                >
              </nz-input-group>
              <div class="character-count">{{descriptionBox.value.length}}/{{MAX_PROJECT_DESCRIPTION_CHAR_COUNT}}</div>
              <ng-template #saveDescriptionIcon>
                <span
                  (click)="removeEditDescriptionStatus(dashboardUserProjectEntry.pid)"
                  *ngIf="descriptionBox.value !== dashboardUserProjectEntry.description"
                  class="ant-input-clear-icon"
                  nz-icon
                  nz-tooltip="Save"
                  nzTheme="fill"
                  nzTooltipPlacement="top"
                  nzType="check-circle"></span>
              </ng-template>
            </ng-template>
          </nz-list-item-meta-description>

          <!-- created time of project -->
          <nz-list-item-meta-description>
            <p>Created: {{dashboardUserProjectEntry.creationTime | date: "yyyy-MM-dd HH:mm"}}</p>
          </nz-list-item-meta-description>
        </nz-list-item-meta>

        <ul nz-list-item-actions>
          <nz-list-item-action>
            <button
              (nzOnConfirm)="deleteProject(dashboardUserProjectEntry.pid)"
              nz-button
              nz-popconfirm
              nz-tooltip="Delete the project {{dashboardUserProjectEntry.name}}"
              nzPopconfirmTitle="Confirm to delete this project."
              nzTooltipPlacement="bottom">
              <i
                nz-icon
                nzTheme="outline"
                nzType="delete"></i>
            </button>
          </nz-list-item-action>
        </ul>
      </nz-list-item>
    </nz-list>
  </nz-card>
</div>
